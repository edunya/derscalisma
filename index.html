<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title>Ders Ã‡alÄ±ÅŸma YÃ¶netimi</title>
    <!-- Stlite'Ä±n daha yeni ve stabil bir versiyonunu kullanÄ±yoruz (0.55.0) -->
    <script src="https://cdn.jsdelivr.net/npm/@stlite/mountable@0.55.0/build/stlite.js"></script>
</head>

<body>
    <div id="root"></div>
    <script>
        stlite.mount(
            {
                requirements: ["plotly", "pandas", "matplotlib", "altair", "pyodide-http", "cryptography", "requests"],
                entrypoint: "main.py",
                files: {
                    "main.py": `import streamlit as st
import pandas as pd
import plotly.express as px
import time
from datetime import datetime
from utils import GithubSync, decrypt_token
import sys

# --- Stlite Patch ---
try:
    import pyodide_http
    pyodide_http.patch_all()
except ImportError:
    pass

# --- GÃœVENLÄ° AYARLAR ---
# 1. 'encrypt_token_helper.py' scriptini Ã§alÄ±ÅŸtÄ±rÄ±n.
# 2. ÃœrettiÄŸi ÅŸifreli metni aÅŸaÄŸÄ±ya yapÄ±ÅŸtÄ±rÄ±n.
ENCRYPTED_GITHUB_TOKEN = "gAAAAABpP9qV1wz1WJafeG727Nt7n9tJtcWLws5e1xcs80fYnGVgta200c-mVrOXDUNqkf0uRvRMZoSrvXS1ueXZgivBrnQvv6F2iekR9n7_mPt12X3mkEK_znMatw5SQZMKKVygsv1ICRXjEf7Oul5znh8f995YIyPoU6g_KeKmuQzbogOm-iF-qgvi7hUDdW9BVmDY3mle" 
REPO_NAME = "edunya/derscalismaData" # Ã–rn: kullaniciadi/repo-adi

# --- Sayfa ---
st.set_page_config(page_title="Study Space", page_icon="ğŸŒ¿", layout="wide", initial_sidebar_state="collapsed")

# --- CSS ---
st.markdown("""
<style>
    @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&display=swap');
    html, body, [class*="css"] { font-family: 'Outfit', sans-serif; }
    .stApp { background: linear-gradient(135deg, #fdfbf7 0%, #e8f5e9 100%); color: #2c3e50; }
    .css-card {
        background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(10px);
        border-radius: 20px; padding: 20px; margin-bottom: 20px;
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
        border: 1px solid rgba(255, 255, 255, 0.18);
    }
    .stButton>button {
        background: linear-gradient(90deg, #556B2F 0%, #7da453 100%);
        color: white; border: none; padding: 10px 24px; border-radius: 12px;
    }
    .stTextInput>div>div>input { background-color: rgba(255, 255, 255, 0.8); border-radius: 10px; }
</style>
""", unsafe_allow_html=True)

# --- State ---
if 'logged_in' not in st.session_state: st.session_state.logged_in = False
if 'username' not in st.session_state: st.session_state.username = ""
if 'decrypted_token' not in st.session_state: st.session_state.decrypted_token = None
if 'study_data' not in st.session_state: st.session_state.study_data = []
if 'data_sha' not in st.session_state: st.session_state.data_sha = None

# --- Helpers ---
def init_github():
    token = st.session_state.decrypted_token
    # Repo ismi kodda yoksa sessiondan (manuel giriÅŸten) al
    repo = REPO_NAME if REPO_NAME else st.session_state.get('gh_repo', "")
    if token and repo:
        return GithubSync(token, repo)
    return None

def load_data():
    gh = init_github()
    if gh:
        with st.spinner('BaÄŸlanÄ±lÄ±yor...'):
            data, sha = gh.fetch_data()
            if data is not None:
                st.session_state.study_data = data
                st.session_state.data_sha = sha
                return True
    return False

def save_data():
    gh = init_github()
    if gh:
        success = gh.push_data(st.session_state.study_data, st.session_state.data_sha)
        if success:
            load_data() # Update SHA
            st.toast("âœ… Kaydedildi")
        else:
            st.toast("âŒ Hata")

# --- Pages ---
def login_page():
    st.markdown("<div style='text-align: center; padding: 50px;'>", unsafe_allow_html=True)
    st.title("ğŸŒ¿ Study Space")
    
    col1, col2, col3 = st.columns([1, 2, 1])
    with col2:
        st.markdown('<div class="css-card">', unsafe_allow_html=True)
        username = st.text_input("KullanÄ±cÄ± AdÄ±", placeholder="AdÄ±nÄ±z")
        password = st.text_input("Grup Åifresi", type="password", placeholder="TokenÄ± ÅŸifrelerken kullandÄ±ÄŸÄ±n parola")
        
        # Manuel ayarlar (eÄŸer kod boÅŸsa)
        if not ENCRYPTED_GITHUB_TOKEN:
            with st.expander("Manuel Ayar (Kod BoÅŸsa)"):
                st.text_input("Repo (user/repo)", key="gh_repo", value=REPO_NAME)

        if st.button("GiriÅŸ Yap", use_container_width=True):
            if not username or not password:
                st.warning("Ad ve Åifre gerekli.")
                return

            # 1. Token Ã‡Ã¶zme Denemesi
            token_to_use = None
            
            if ENCRYPTED_GITHUB_TOKEN:
                decrypted = decrypt_token(ENCRYPTED_GITHUB_TOKEN, password)
                if decrypted:
                    token_to_use = decrypted
                else:
                    st.error("HatalÄ± Åifre! Token Ã§Ã¶zÃ¼lemedi.")
                    return
            else:
                 st.error("Kod iÃ§inde ENCRYPTED_GITHUB_TOKEN tanÄ±mlÄ± deÄŸil. LÃ¼tfen kurulumu yapÄ±n.")
                 return

            # 2. BaÅŸarÄ±lÄ± ise login
            st.session_state.username = username
            st.session_state.decrypted_token = token_to_use
            
            if load_data():
                st.session_state.logged_in = True
                st.success("GiriÅŸ BaÅŸarÄ±lÄ±!")
                st.rerun()
            else:
                st.error("GitHub'a baÄŸlanÄ±lamadÄ±. Token doÄŸru Ã§Ã¶zÃ¼ldÃ¼ ama repo eriÅŸimi yok veya repo ismi yanlÄ±ÅŸ.")
                
        st.markdown('</div>', unsafe_allow_html=True)

def main_app():
    c1, c2 = st.columns([8, 1])
    c1.title(f"ğŸ‘‹ {st.session_state.username}")
    if c2.button("Ã‡Ä±kÄ±ÅŸ"):
        st.session_state.logged_in = False
        st.session_state.decrypted_token = None
        st.rerun()

    col_main, col_sidebar = st.columns([3, 1])
    
    with col_sidebar:
        # Pomodoro
        st.markdown('<div class="css-card">', unsafe_allow_html=True)
        st.subheader("â±ï¸ Pomodoro")
        if 'time_left' not in st.session_state: st.session_state.time_left = 25*60
        if 'timer_active' not in st.session_state: st.session_state.timer_active = False
        sure = st.slider("Dakika", 5, 90, 25, 5)
        if st.button("BaÅŸlat"): 
            st.session_state.timer_active = True
            st.session_state.time_left = sure*60
        if st.button("Dur"): st.session_state.timer_active = False
        
        if st.session_state.timer_active:
             m, s = divmod(st.session_state.time_left, 60)
             st.markdown(f"<h2 style='text-align:center;color:#556B2F'>{m:02d}:{s:02d}</h2>", unsafe_allow_html=True)
        st.markdown('</div>', unsafe_allow_html=True)
        
        # Ekle
        st.markdown('<div class="css-card">', unsafe_allow_html=True)
        st.subheader("Ekle")
        ders = st.text_input("Ders")
        dk = st.number_input("SÃ¼re", value=sure)
        if st.button("Kaydet"):
            st.session_state.study_data.append({
                "user": st.session_state.username,
                "ders": ders,
                "sure": dk,
                "tarih": str(datetime.now().date()),
                "timestamp": str(datetime.now())
            })
            save_data()
        st.markdown('</div>', unsafe_allow_html=True)

    with col_main:
        # Grafik
        st.markdown('<div class="css-card">', unsafe_allow_html=True)
        my_data = [d for d in st.session_state.study_data if d['user'] == st.session_state.username]
        if my_data:
            df = pd.DataFrame(my_data)
            daily = df.groupby('tarih')['sure'].sum().reset_index()
            fig = px.bar(daily, x='tarih', y='sure', color='sure', title="Ã‡alÄ±ÅŸmalarÄ±m", color_continuous_scale=['#dcedc8', '#33691e'])
            fig.update_layout(paper_bgcolor="rgba(0,0,0,0)", plot_bgcolor="rgba(0,0,0,0)")
            st.plotly_chart(fig, use_container_width=True)
        else:
            st.info("Veri yok.")
        st.markdown('</div>', unsafe_allow_html=True)
        
        # Tablo
        st.markdown('<div class="css-card">', unsafe_allow_html=True)
        all_df = pd.DataFrame(st.session_state.study_data)
        if not all_df.empty:
            rank = all_df.groupby('user')['sure'].sum().reset_index().sort_values('sure', ascending=False)
            st.subheader("Skor Tablosu")
            st.dataframe(rank, hide_index=True, use_container_width=True)
        st.markdown('</div>', unsafe_allow_html=True)`,
                    "utils.py": `import json
import base64
import requests
import datetime
import streamlit as st
from cryptography.fernet import Fernet
import hashlib

# --- Åifreleme HelperlarÄ± ---
def get_key_from_password(password):
    """Paroladan 32-byte Fernet anahtarÄ± Ã¼retir."""
    digest = hashlib.sha256(password.encode()).digest()
    return base64.urlsafe_b64encode(digest)

def decrypt_token(encrypted_token, password):
    """Åifreli tokenÄ± parolayÄ± kullanarak Ã§Ã¶zer."""
    try:
        key = get_key_from_password(password)
        f = Fernet(key)
        return f.decrypt(encrypted_token.encode()).decode()
    except Exception as e:
        return None

# --- GitHub Sync SÄ±nÄ±fÄ± ---
class GithubSync:
    def __init__(self, token, repo_name, file_path="data.json"):
        self.token = token
        self.repo_name = repo_name
        self.file_path = file_path
        self.base_url = f"https://api.github.com/repos/{repo_name}/contents/{file_path}"
        self.headers = {
            "Authorization": f"token {token}",
            "Accept": "application/vnd.github.v3+json"
        }

    def fetch_data(self):
        try:
            response = requests.get(self.base_url, headers=self.headers)
            if response.status_code == 200:
                content = response.json()
                decoded_content = base64.b64decode(content['content']).decode('utf-8')
                return json.loads(decoded_content), content['sha']
            elif response.status_code == 404:
                return [], None
            else:
                st.error(f"Veri Ã§ekme hatasÄ±: {response.status_code}")
                return [], None
        except Exception as e:
            st.error(f"BaÄŸlantÄ± hatasÄ±: {e}")
            return [], None

    def push_data(self, data, sha=None):
        try:
            json_data = json.dumps(data, indent=4, ensure_ascii=False)
            message = f"Update: {datetime.datetime.now().strftime('%Y-%m-%d %H:%M')}"
            
            payload = {
                "message": message,
                "content": base64.b64encode(json_data.encode('utf-8')).decode('utf-8')
            }
            if sha:
                payload["sha"] = sha

            response = requests.put(self.base_url, headers=self.headers, json=payload)
            return response.status_code in [200, 201]
        except Exception as e:
            st.error(f"YÃ¼kleme hatasÄ±: {e}")
            return False`
                },
            },
            document.getElementById("root")
        );
    </script>
</body>

</html>
