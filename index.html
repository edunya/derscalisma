<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study Space</title>
    <!-- Gerekli K√ºt√ºphaneler -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <!-- Font -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #556B2F;
            --primary-light: #7da453;
            --bg-gradient: linear-gradient(135deg, #fdfbf7 0%, #e8f5e9 100%);
            --glass-bg: rgba(255, 255, 255, 0.6);
            --glass-border: 1px solid rgba(255, 255, 255, 0.18);
            --text-color: #2c3e50;
        }

        * {
            box-sizing: border-box;
            font-family: 'Outfit', sans-serif;
            transition: all 0.3s ease;
        }

        body {
            margin: 0;
            padding: 20px;
            background: var(--bg-gradient);
            color: var(--text-color);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Glassmorphism Cards */
        .card {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
            border: var(--glass-border);
            margin-bottom: 24px;
        }

        /* Inputs & Buttons */
        input,
        select {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border-radius: 12px;
            border: 1px solid #e0e0e0;
            background: rgba(255, 255, 255, 0.8);
            font-size: 1rem;
            outline: none;
        }

        input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(85, 107, 47, 0.1);
        }

        button {
            width: 100%;
            padding: 12px;
            margin-top: 8px;
            border-radius: 12px;
            border: none;
            background: linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            font-weight: 600;
            cursor: pointer;
            font-size: 1rem;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(85, 107, 47, 0.3);
        }

        button.secondary {
            background: #e0e0e0;
            color: #333;
        }

        button.danger {
            background: #ff6b6b;
            color: white;
        }

        /* Grid Layouts */
        .grid {
            display: grid;
            gap: 24px;
        }

        @media (min-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr 2fr;
            }

            .grid-3 {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        /* Stats */
        .stat-value {
            font-size: 2rem;
            font-weight: 600;
            color: var(--primary);
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
        }

        /* Timer */
        .timer-display {
            font-size: 4rem;
            text-align: center;
            color: var(--primary);
            font-weight: 300;
            margin: 20px 0;
        }

        /* Toast Notification */
        #toast {
            visibility: hidden;
            min-width: 250px;
            margin-left: -125px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 10px;
            padding: 16px;
            position: fixed;
            z-index: 1;
            left: 50%;
            bottom: 30px;
            font-size: 17px;
        }

        #toast.show {
            visibility: visible;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }

        @keyframes fadein {
            from {
                bottom: 0;
                opacity: 0;
            }

            to {
                bottom: 30px;
                opacity: 1;
            }
        }

        @keyframes fadeout {
            from {
                bottom: 30px;
                opacity: 1;
            }

            to {
                bottom: 0;
                opacity: 0;
            }
        }
    </style>
</head>

<body>

    <!-- CONFIGURATION AREA -->
    <!-- Bu kƒ±smƒ± d√ºzenleyeceksiniz -->
    <script>
        // --- AYARLAR ---
        // A≈üaƒüƒ±daki tƒ±rnaklarƒ±n i√ßine encrypt_token_tool.html ile √ºrettiƒüiniz kodu yapƒ±≈ütƒ±rƒ±n.
        const CONFIG = {
            ENCRYPTED_TOKEN: "U2FsdGVkX18I9NNIuRG/GH8ry/gqUdGgUTZYLTfqxTTM6e9xVX6N3C2OG5fZuHWjBPkRo7ZKDIStHEN7VxIlszvlWCrILlM3EbCWM+ogBy02zNq268+Prxm+MRApJa4UoqSP+BKZOp5ZGQ50ATO2hA==",
            REPO: "edunya/derscalismaData" // √ñrn: kullaniciadi/calisma-verileri
        };
    </script>

    <div id="toast">Bildirim</div>

    <!-- Login Screen -->
    <div id="login-screen" class="container" style="max-width: 400px; margin-top: 10vh;">
        <div class="card text-center">
            <h1>üåø Study Space</h1>
            <p>Giri≈ü Yap</p>
            <input type="text" id="username" placeholder="Adƒ±nƒ±z">
            <input type="password" id="password" placeholder="Grup ≈ûifresi">
            <button onclick="app.login()">Giri≈ü Yap</button>


        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="container hidden">
        <!-- Header -->
        <div class="card" style="display: flex; justify-content: space-between; align-items: center;">
            <h2 id="welcome-msg" style="margin:0;">üëã Ho≈ügeldin</h2>
            <div style="display: flex; gap: 10px;">
                <button onclick="app.sync()" style="margin:0; width: auto;">üîÑ E≈üitle</button>
                <button class="secondary" onclick="location.reload()" style="margin:0; width: auto;">√áƒ±kƒ±≈ü</button>
            </div>
        </div>

        <div class="grid grid-2">
            <!-- Sidebar -->
            <div>
                <!-- Pomodoro -->
                <div class="card text-center">
                    <h3>‚è±Ô∏è Pomodoro</h3>
                    <div class="timer-display" id="timer">25:00</div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="timer.start()">Ba≈ülat</button>
                        <button class="secondary" onclick="timer.stop()">Dur</button>
                    </div>
                    <div style="margin-top: 15px;">
                        <label>S√ºre (dk): <span id="time-val">25</span></label>
                        <input type="range" min="5" max="90" value="25" step="5"
                            oninput="timer.setDuration(this.value)">
                    </div>
                </div>

                <!-- Add Task -->
                <div class="card">
                    <h3>üìù Ders Ekle</h3>
                    <input type="text" id="task-name" placeholder="Ders (Matematik vb.)">
                    <input type="number" id="task-duration" placeholder="S√ºre (dk)" value="25">
                    <button onclick="app.addTask()">Kaydet</button>
                </div>
            </div>

            <!-- Main Content -->
            <div>
                <!-- Stats -->
                <div class="card">
                    <div class="grid grid-3 text-center">
                        <div>
                            <div class="stat-value" id="stat-total">0</div>
                            <div class="stat-label">Toplam Dk</div>
                        </div>
                        <div>
                            <div class="stat-value" id="stat-count">0</div>
                            <div class="stat-label">Oturum</div>
                        </div>
                        <div>
                            <div class="stat-value" id="stat-streak">0</div>
                            <div class="stat-label">G√ºnl√ºk Seri</div>
                        </div>
                    </div>
                </div>

                <!-- Chart -->
                <div class="card">
                    <div id="heatmap" style="width: 100%; height: 300px;"></div>
                </div>

                <!-- Leaderboard -->
                <div class="card">
                    <h3>üèÜ Arkada≈ü Sƒ±ralamasƒ±</h3>
                    <div id="leaderboard"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- APP LOGIC ---
        const app = {
            user: "",
            token: "",
            data: [],
            sha: null,

            login: async function () {
                const user = document.getElementById('username').value;
                const pass = document.getElementById('password').value;

                if (!user || !pass) return this.toast("L√ºtfen bilgileri girin.");

                // 1. Decrypt Token
                try {
                    // Eƒüer CONFIG bo≈üsa, manuel moda ge√ß (geli≈ütirme i√ßin)
                    let encrypted = CONFIG.ENCRYPTED_TOKEN;
                    if (!encrypted) {
                        alert("L√ºtfen √∂nce 'Kurulum' butonuna basƒ±p ayarlarƒ± yapƒ±n ve index.html dosyasƒ±na kaydedin.");
                        return;
                    }

                    const bytes = CryptoJS.AES.decrypt(encrypted, pass);
                    const decryptedToken = bytes.toString(CryptoJS.enc.Utf8);

                    if (!decryptedToken || !decryptedToken.startsWith("gh")) {
                        throw new Error("Hatalƒ± ≈üifre");
                    }

                    this.token = decryptedToken;
                    this.user = user;

                    document.getElementById('welcome-msg').innerText = `üëã Selam, ${user}`;

                    // 2. Fetch Data
                    await this.sync(true);

                    // 3. Show Dashboard
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('dashboard').classList.remove('hidden');
                    this.toast("Giri≈ü Ba≈üarƒ±lƒ±!");

                } catch (e) {
                    console.error(e);
                    this.toast("Hatalƒ± ≈ûifre veya Token!");
                }
            },

            sync: async function (silent = false) {
                if (!silent) this.toast("E≈üitleniyor...");
                const repo = CONFIG.REPO || localStorage.getItem('temp_repo');
                if (!repo) return this.toast("Repo ayarƒ± eksik!");

                const url = `https://api.github.com/repos/${repo}/contents/data.json`;

                try {
                    const res = await fetch(url, {
                        headers: {
                            'Authorization': `token ${this.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });

                    if (res.status === 404) {
                        // Dosya yoksa bo≈ü ba≈ülat
                        this.data = [];
                        return;
                    }

                    if (!res.ok) throw new Error("GitHub Hatasƒ±: " + res.status);

                    const json = await res.json();
                    this.sha = json.sha;
                    const content = atob(json.content); // Base64 decode
                    // UTF-8 fix for Turkish characters
                    const decoded = decodeURIComponent(Array.prototype.map.call(content, function (c) {
                        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                    }).join(''));

                    this.data = JSON.parse(decoded);
                    if (!silent) this.toast("Veriler G√ºncel!");
                    this.renderStats();

                } catch (e) {
                    console.error(e);
                    if (!silent) this.toast("Baƒülantƒ± Hatasƒ±!");
                }
            },

            addTask: async function () {
                const name = document.getElementById('task-name').value;
                const dur = parseInt(document.getElementById('task-duration').value);

                if (!name || !dur) return this.toast("Eksik bilgi!");

                const entry = {
                    user: this.user,
                    ders: name,
                    sure: dur,
                    tarih: new Date().toISOString().split('T')[0],
                    ts: new Date().toISOString()
                };

                this.data.push(entry);
                this.toast("Yerel olarak eklendi...");
                this.renderStats();

                // Save to GitHub
                const repo = CONFIG.REPO;
                const url = `https://api.github.com/repos/${repo}/contents/data.json`;

                // Turkish chars to Base64
                const jsonStr = JSON.stringify(this.data, null, 2);
                const encoded = btoa(unescape(encodeURIComponent(jsonStr)));

                const payload = {
                    message: "Update data",
                    content: encoded,
                    sha: this.sha
                };

                try {
                    const res = await fetch(url, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${this.token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });

                    if (res.ok) {
                        const respJson = await res.json();
                        this.sha = respJson.content.sha;
                        this.toast("‚òÅÔ∏è GitHub'a Kaydedildi!");
                    } else {
                        throw new Error("Kayƒ±t hatasƒ±");
                    }
                } catch (e) {
                    this.toast("Kayƒ±t Ba≈üarƒ±sƒ±z! (ƒ∞nterneti kontrol et)");
                }
            },

            renderStats: function () {
                // Filter my data
                const myData = this.data.filter(d => d.user === this.user);

                // Stats
                const total = myData.reduce((a, b) => a + b.sure, 0);
                document.getElementById('stat-total').innerText = total;
                document.getElementById('stat-count').innerText = myData.length;

                // Chart (Plotly)
                const dates = {};
                myData.forEach(d => {
                    dates[d.tarih] = (dates[d.tarih] || 0) + d.sure;
                });

                const x = Object.keys(dates).sort();
                const y = x.map(k => dates[k]);

                const trace = {
                    x: x, y: y, type: 'bar',
                    marker: { color: '#556B2F' }
                };

                const layout = {
                    title: 'G√ºnl√ºk √áalƒ±≈üma (Dk)',
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    plot_bgcolor: 'rgba(0,0,0,0)',
                    margin: { t: 30, r: 10, l: 30, b: 30 },
                    font: { family: 'Outfit' }
                };

                Plotly.newPlot('heatmap', [trace], layout, { displayModeBar: false });

                // Leaderboard
                const users = {};
                this.data.forEach(d => {
                    users[d.user] = (users[d.user] || 0) + d.sure;
                });

                let html = '<table style="width:100%; text-align:left;"><tr><th>ƒ∞sim</th><th>Toplam (Dk)</th></tr>';
                Object.entries(users)
                    .sort((a, b) => b[1] - a[1])
                    .forEach(([u, s]) => {
                        html += `<tr><td>${u} ${u === this.user ? ' (Sen)' : ''}</td><td>${s}</td></tr>`;
                    });
                html += '</table>';
                document.getElementById('leaderboard').innerHTML = html;
            },

            toast: function (msg) {
                const t = document.getElementById("toast");
                t.className = "show";
                t.innerText = msg;
                setTimeout(function () { t.className = t.className.replace("show", ""); }, 3000);
            }
        };

        // --- TIMER LOGIC ---
        const timer = {
            interval: null,
            timeLeft: 25 * 60,

            setDuration: function (min) {
                document.getElementById('time-val').innerText = min;
                if (!this.interval) {
                    this.timeLeft = min * 60;
                    this.updateDisplay();
                }
            },

            start: function () {
                if (this.interval) return;
                this.interval = setInterval(() => {
                    this.timeLeft--;
                    this.updateDisplay();
                    if (this.timeLeft <= 0) {
                        this.stop();
                        alert("S√ºre Doldu!");
                    }
                }, 1000);
            },

            stop: function () {
                clearInterval(this.interval);
                this.interval = null;
            },

            updateDisplay: function () {
                const m = Math.floor(this.timeLeft / 60);
                const s = this.timeLeft % 60;
                document.getElementById('timer').innerText =
                    `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            }
        };
    </script>
</body>

</html>

